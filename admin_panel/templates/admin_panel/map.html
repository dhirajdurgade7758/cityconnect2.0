{% extends "admin_panel/base.html" %}
{% load static %}

{% block title %}Interactive Issues Map{% endblock title %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/map.css' %}">
<style>
  /* Layout Styles */
  .map-container { display: flex; height: calc(100vh - 56px); }
  #map-panel { flex-grow: 1; height: 100%; }
  #sidebar-panel { width: 400px; height: 100%; overflow-y: auto; background-color: #fff; border-left: 1px solid #dee2e6; }
  .sidebar-header { padding: 1rem 1.5rem; border-bottom: 1px solid #dee2e6; background-color: #f8f9fa; }
  
  /* Sidebar List Item Styles */
  .issue-list-item { padding: 1rem 1.5rem; cursor: pointer; border-bottom: 1px solid #e9ecef; transition: background-color 0.2s; }
  .issue-list-item:hover { background-color: #f8f9fa; }
  .issue-list-item.active { background-color: #e7f1ff; border-left: 4px solid #0d6efd; padding-left: calc(1.5rem - 4px); }
  
  /* Custom Marker Style */
  .custom-marker { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: transform 0.2s ease-in-out; }
  .custom-marker:hover { transform: scale(1.5); }

  /* ✅ RESTORED: Detailed InfoWindow CSS from your first version */
  .info-window { max-width: 320px; padding: 0; }
  .info-window .info-title { font-size: 1.25rem; font-weight: bold; margin: 10px 15px; }
  .info-window .info-img { width: 100%; height: 180px; object-fit: cover; }
  .info-window .info-body { padding: 10px 15px 15px 15px; }
  .info-window p { margin: 0 0 10px 0; line-height: 1.5; }
  .info-window .status { text-transform: capitalize; font-weight: bold; padding: 3px 8px; border-radius: 12px; color: #fff; }
  .info-window .status.pending, .info-window .status.open { background-color: #ff5252; }
  .info-window .status.in_progress { background-color: #ffca28; color: #000; }
  .info-window .status.resolved { background-color: #4caf50; }
  .info-window .info-actions { margin-top: 15px; display: flex; gap: 10px; }
  .info-window .view-btn, .info-window .resolve-btn { flex: 1; padding: 8px; border: none; border-radius: 5px; text-decoration: none; text-align: center; font-weight: bold; cursor: pointer; }
  .info-window .view-btn { background-color: #f0f0f0; color: #333; }
  .info-window .resolve-btn { background-color: #0d6efd; color: #fff; }
  .info-window .resolve-btn:disabled { background-color: #6c757d; cursor: not-allowed; }
</style>
{% endblock extra_head %}

{% block content %}
<div class="map-container">
  <div id="map-panel"></div>
  <aside id="sidebar-panel">
    <div class="sidebar-header">
      <h5 class="mb-0 fw-bold"><i class="bi bi-list-task me-2"></i>Issues in Gwalior</h5>
      <p class="text-muted small mb-0">Click an issue to view it on the map</p>
    </div>
    <div id="issue-list-container"></div>
  </aside>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  let map;
  const markers = [];
  const infoWindows = [];

  function initMap() {
    const locations = {{ locations|safe }};
    if (locations.length === 0) return;

    map = new google.maps.Map(document.getElementById("map-panel"), {
      center: { lat: locations[0].lat, lng: locations[0].lng },
      zoom: 12,
      mapId: "166a24379880273b1db32e96"
    });

    const statusColors = { pending: "#ff5252", in_progress: "#ffca28", resolved: "#4caf50" };
    const issueListContainer = document.getElementById("issue-list-container");

    locations.forEach(location => {
      // 1. Populate sidebar list
      const listItem = document.createElement("div");
      listItem.className = "issue-list-item";
      listItem.id = `issue-item-${location.id}`;
      listItem.innerHTML = `<div class="d-flex justify-content-between"><span class="fw-bold text-truncate pe-2">${location.name}</span><span class="badge rounded-pill ${getStatusBadgeClass(location.status)}">${location.status.replace('_',' ')}</span></div><small class="text-muted">${location.department}</small>`;
      issueListContainer.appendChild(listItem);

      // 2. Create map marker
      const markerDiv = document.createElement("div");
      markerDiv.className = "custom-marker";
      markerDiv.style.backgroundColor = statusColors[location.status] || "#9e9e9e";
      const marker = new google.maps.marker.AdvancedMarkerElement({
        position: { lat: location.lat, lng: location.lng }, map: map, title: location.name, content: markerDiv
      });

      // ✅ 3. Create a FULLY FEATURED InfoWindow
      const resolveButtonHTML = location.status === "resolved"
        ? `<button class="resolve-btn" disabled>Resolved</button>`
        : `<a class="resolve-btn" href="${location.resolve_url}">Resolve Issue</a>`;
      
      const infoWindow = new google.maps.InfoWindow({
        maxWidth: 350, // Set a max width to keep it tidy
        content: `
          <div class="info-window">
              <h3 class="info-title">${location.name}</h3>
              <img src="${location.image}" alt="${location.name}" class="info-img"/>
              <div class="info-body">
                  <p><strong>Status:</strong> 
                      <span class="status ${location.status}">${location.status.replace('_',' ')}</span>
                  </p>
                  <p>${location.description}</p>
                  <div class="info-actions">
                      <a href="${location.url}" class="view-btn">View Details</a>
                      ${resolveButtonHTML}
                  </div>
              </div>
          </div>
        `
      });

      // Store for later access
      markers[location.id] = marker;
      infoWindows[location.id] = infoWindow;

      // Add listeners
      marker.addListener("click", () => handleIssueSelection(location));
      listItem.addEventListener("click", () => handleIssueSelection(location));
    });
  }

  function handleIssueSelection(location) {
    map.panTo({ lat: location.lat, lng: location.lng });
    if (map.getZoom() < 15) {
        map.setZoom(15);
    }

    Object.values(infoWindows).forEach(iw => iw.close());
    infoWindows[location.id].open(map, markers[location.id]);

    document.querySelectorAll('.issue-list-item').forEach(item => item.classList.remove('active'));
    document.getElementById(`issue-item-${location.id}`).classList.add('active');
  }

  function getStatusBadgeClass(status) {
    if (status === 'resolved') return 'bg-success-subtle text-success-emphasis';
    if (status === 'in_progress') return 'bg-warning-subtle text-warning-emphasis';
    return 'bg-danger-subtle text-danger-emphasis';
  }

  window.initMap = initMap;
</script>

<script async src="https://maps.googleapis.com/maps/api/js?key={{key}}&callback=initMap&loading=async&v=weekly&libraries=marker"></script>
{% endblock extra_scripts %}
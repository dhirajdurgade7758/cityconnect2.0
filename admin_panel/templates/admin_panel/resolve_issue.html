{% extends 'admin_panel/base.html' %}
{% load widget_tweaks %}

{% block content %}

<style>
  body { background-color: #f8f9fa; }
  /* {# NEW: Style for the enhanced file input #} */
  .file-drop-area {
    position: relative;
    padding: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    border: 2px dashed #ccc;
    border-radius: .5rem;
    background-color: #f8f9fa;
    transition: all .2s;
  }
  .file-drop-area:hover {
    border-color: #0d6efd;
    background-color: #e9ecef;
  }
  .file-drop-area input[type=file] {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    opacity: 0;
    cursor: pointer;
  }
</style>

<div class="container py-5">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h2 mb-0 fw-light">Issue Resolution Center</h1>
      <p class="mb-0 text-muted">Review details and update the status of the reported issue.</p>
    </div>
    <a href="#" class="btn btn-outline-secondary d-none d-md-inline-flex">
      <i class="bi bi-arrow-left me-2"></i>Back to All Issues
    </a>
  </div>

  <div class="row g-4 g-lg-5">

    <div class="col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-start">
          <div>
            <h4 class="mb-1">{{ issue.title }}</h4>
            <small class="text-muted">ID: #{{ issue.id }}</small>
          </div>
          
          {# MODIFIED: Added a specific style for 'Pending' status #}
          <span class="badge fs-6 rounded-pill
            {% if issue.status == 'Resolved' %} bg-success-subtle text-success-emphasis border border-success-subtle
            {% elif issue.status == 'In Progress' %} bg-warning-subtle text-warning-emphasis border border-warning-subtle
            {% elif issue.status == 'Pending' %} bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle
            {% else %} bg-danger-subtle text-danger-emphasis border border-danger-subtle
            {% endif %}">
            <i class="bi bi-circle-fill me-1" style="font-size: 0.6em;"></i>{{ issue.status }}
          </span>
        </div>

        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-4 p-3 bg-light rounded">
            <i class="bi bi-person-circle fs-2 text-secondary me-3"></i>
            <div>
              <div class="fw-bold">{{ issue.user.username|default:'Anonymous User' }}</div>
              <div class="text-muted small">Reported on {{ issue.created_at|date:"F d, Y \a\t P" }}</div>
            </div>
          </div>

          <h6 class="text-uppercase text-muted small fw-bold">Description</h6>
          <p class="text-body-secondary mb-4 pb-3 border-bottom">
            {{ issue.description|linebreaksbr }}
          </p>

          {% if issue.image %}
          <h6 class="text-uppercase text-muted small fw-bold">Evidence Submitted</h6>
          <a href="{{ issue.image.url }}" target="_blank" class="d-block">
            <img src="{{ issue.image.url }}" alt="Issue Image" class="img-fluid rounded border shadow-sm" style="max-height: 400px;">
          </a>
          {% else %}
          <h6 class="text-uppercase text-muted small fw-bold">Evidence Submitted</h6>
          <p class="text-muted fst-italic">No image was provided with this report.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0 pt-4 px-4">
          <h4 class="mb-0"><i class="bi bi-pencil-square text-primary me-2"></i>Take Action</h4>
        </div>

        <div class="card-body p-4">
          <form method="POST" enctype="multipart/data" class="d-flex flex-column h-100">
            {% csrf_token %}
            
            <div class="flex-grow-1">
              <div class="mb-4">
                <label for="{{ form.status.id_for_label }}" class="form-label fw-bold"><span class="badge bg-primary rounded-circle me-2">1</span>Set New Status</label>
                {% render_field form.status class="form-select form-select-lg" %}
              </div>

              <div class="mb-4">
                <label for="{{ form.resolved_description.id_for_label }}" class="form-label fw-bold"><span class="badge bg-primary rounded-circle me-2">2</span>Provide Resolution Notes</label>
                {% render_field form.resolved_description class="form-control" rows="7" placeholder="Clearly explain the actions taken and the outcome..." %}
                {# NEW: Contextual helper text #}
                <div class="form-text mt-2">
                  <i class="bi bi-lightbulb"></i> <strong>Tip:</strong> For a drainage issue, mention the team assigned (e.g., Municipal Corp), actions taken (e.g., cleared blockage), and estimated completion time.
                </div>
              </div>

              <div class="mb-3">
                <label for="{{ form.resolved_image.id_for_label }}" class="form-label fw-bold"><span class="badge bg-primary rounded-circle me-2">3</span>Attach Proof of Resolution (Optional)</label>
                {# NEW: Enhanced file input area #}
                <div class="file-drop-area">
                    <span class="file-msg text-muted">
                        <i class="bi bi-cloud-arrow-up me-2"></i>Click to browse or drag file here
                    </span>
                    {% render_field form.resolved_image %}
                </div>
              </div>
            </div>

            <div class="mt-auto pt-4 border-top">
              <div class="d-grid">
                {# MODIFIED: Dynamic button text #}
                <button type="submit" class="btn btn-success btn-lg">
                  <i class="bi bi-check2-circle me-2"></i>
                  {% if issue.status == 'Resolved' %}
                    Update Resolution Details
                  {% else %}
                    Confirm and Save Update
                  {% endif %}
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}